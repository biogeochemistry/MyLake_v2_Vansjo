function [DOCz1_new,DOCz2_new,DOCz3_new,DOC1frac,DOC2frac,DOC3frac,Kd_new,Daily_BB1,Daily_BB2,Daily_BB3,Daily_PB]=fokema_new(DOCz1,DOCz2,DOCz3,Kd_old,Q0,T,Theeta,Date,Depth)

%Fokema model code for MyLake model 04.10.2010

%What value of theeta should be used?

%DOCz   Vertical profile of DOC [mg m-3]

%Kd_old, Kd_new	Old and new diffuse attenuation coefficient
%Q0		Global radiance [MJ m-2 d-1]
%T		Temperature. Also a vector of temperatures
%Theeta		Solar elevation
%Depth		Depth of water layers. Vectorized.
%		Bacterial decay for all levels. Photobleaching for top 
%		0.5m only.

wavelength=300:1:800;
albedo=0.06;
%S=0.014; %Slope factor (Not used)

%Bacterial decay
%BDC1=0.0378; %d-1 %0.0628 0.0378
%BDC2=0.003346;    %0.005846 0.003346
%BDC3=0;        

%New values Aarnos 10.12.2008
BDC1 = 0.0666;% d-1          fraktio DOC1 = 0.0775
BDC2 = 0.00746;% d-1         fraktio DOC2 = 0.1486
BDC3 = 0;% d-1               fraktio DOC3 = 0.7739

%Daily dose of photons (mol m-2 d-1)/daily mean global radiation (W m-2)
%load IO/Qlambda.txt;
DDOP=ddop_func; %Monthly values
%DDOP=Qlambda(1:501,Date);

%AQY for photomineralization [mol C (mol photons)-1 nm-1]
AQY=aqy_func;

%Daily dose of photons in air (mol m-2 d-1 nm-1); 11,574 converts MJ d-1 to W
DDOPIA=11.574.*Q0.*DDOP;

%Daily dose of photons below the surface (mol m-2 d-1)
DDOPBS=DDOPIA.*(1-albedo);

%Daily photomineralization (mol C m-2 d-1 nm-1)
DPBs=DDOPBS(1:501).*AQY;

%Daily photomineralization (g C m-3 d-1)
DPB=sum(DPBs).*12./2; %mol -> g transformation for C. Mineralization happens in a 2m layer

%Temperature correction using Arrhenius equation k=Aexp(-Ea/(RT))
%Ea=25; %kJ/mol Mineralisation activation energy
Ea=20650; %J/mol Aarnos 10.12.2008
R=8.314472; %J/(K mol) Gas constant 


%DPB=DPB.*exp(-Ea./(R.*(T(1)+273.15)))/exp(-Ea./(R.*(20+273.15)));

%Calculate new absorption
%Photobleaching plus bacterial decay
%Temperature correction according to Tulonen, 1993, Microb. Ecol.

DOC1frac=zeros(1,length(Depth));
DOC2frac=zeros(1,length(Depth));
DOC3frac=zeros(1,length(Depth));

for index=1:length(Depth)
    if T(index) > 5 
        BDC1n=BDC1;        
        BDC2n=BDC2;
        BDC3n=BDC3;        
    elseif T(index)<=5
        BDC1n=T(index)*BDC1./5;
        BDC2n=T(index)*BDC2./5;
        BDC3n=T(index)*BDC3./5;        
        
    end

%Photobleaching for top 0.5m only
    DOC1frac(index)=0.0775;%DOCz1(index)/(DOCz1(index)+DOCz2(index)+DOCz3(index));%
    DOC2frac(index)=0.1486;%DOCz2(index)/(DOCz1(index)+DOCz2(index)+DOCz3(index));%
    DOC3frac(index)=0.7739;%DOCz3(index)/(DOCz1(index)+DOCz2(index)+DOCz3(index));%
    
    if Depth(index) <= 0.5
        DOCz1_new(index)=DOCz1(index).*exp(-BDC1n)-DOC1frac(index).*DPB;%0.0775.*DPB;%0.086.*DPB;
        DOCz2_new(index)=DOCz2(index).*exp(-BDC2n)-DOC2frac(index).*DPB;%0.1486.*DPB;%0.1531.*DPB;        
        DOCz3_new(index)=DOCz3(index).*exp(-BDC3n)-DOC3frac(index).*DPB;%0.7739.*DPB;%0.7609.*DPB;
        %a_new(index)=a_old(index).*(exp(-BDCn))-DPB;
        Daily_BB1(index)=DOCz1(index)-DOCz1(index).*exp(-BDC1n);
        Daily_BB2(index)=DOCz2(index)-DOCz2(index).*exp(-BDC2n);
        Daily_BB3(index)=DOCz3(index)-DOCz3(index).*exp(-BDC3n);
        Daily_PB(index)=DPB;
    elseif Depth(index) > 0.5
        DOCz1_new(index)=DOCz1(index).*exp(-BDC1n);
        DOCz2_new(index)=DOCz2(index).*exp(-BDC2n);
        DOCz3_new(index)=DOCz3(index).*exp(-BDC3n);
        %a_new(index)=a_old(index).*exp(-BDCn);
        Daily_BB1(index)=DOCz1(index)-DOCz1(index).*exp(-BDC1n);
        Daily_BB2(index)=DOCz2(index)-DOCz2(index).*exp(-BDC2n);
        Daily_BB3(index)=DOCz3(index)-DOCz3(index).*exp(-BDC3n);
        Daily_PB(index)=0;
    end


    
    %Calculating new Kd
%    Kd_new=Kd_old-(a_old(index)-a_new(index)); %Really, really crude approximation
    Kd_new=0;
end

%a280_new=a_new.*exp(-S*(280-420));
%DOCz_new=(a280_new+5.9416)./0.808;

%for index=1:length(Depth)
%if(DOCz_new(index)>DOCz(index))
%        DOCz_new(index)=DOCz(index);
       %fprintf('New DOC larger than old\n');
%end
%if(DOCz_new(index)<0)
%        DOCz_new(index)=0;
%end
%end

DOCz1_new=DOCz1_new';
DOCz2_new=DOCz2_new';
DOCz3_new=DOCz3_new';

function [AQY]=aqy_func
lambda=[300:800]';
%c=1.2374;
c=1.9541; %Aarnos 10.12.2008
d=0.024; %nm-1

AQY=c.*exp(-d.*lambda);
%Note: from 300 to 800nm

function [AQY]=aqy_func_old
AQY=[0.017970634
0.017770485
0.017572566
0.017376852
0.017183317
0.016991937
0.016802689
0.016615549
0.016430493
0.016247498
0.016066542
0.0158876
0.015710652
0.015535674
0.015362646
0.015191544
0.015022348
0.014855036
0.014689588
0.014525983
0.014364199
0.014204218
0.014046018
0.013889581
0.013734885
0.013581913
0.013430644
0.01328106
0.013133142
0.012986871
0.01284223
0.012699199
0.012557762
0.0124179
0.012279595
0.012142831
0.01200759
0.011873855
0.01174161
0.011610838
0.011481522
0.011353646
0.011227195
0.011102152
0.010978502
0.010856228
0.010735317
0.010615752
0.010497519
0.010380603
0.010264989
0.010150662
0.010037609
0.009925815
0.009815266
0.009705949
0.009597848
0.009490952
0.009385247
0.009280718
0.009177354
0.009075141
0.008974067
0.008874118
0.008775282
0.008677548
0.008580901
0.008485331
0.008390826
0.008297373
0.008204961
0.008113578
0.008023213
0.007933854
0.007845491
0.007758112
0.007671706
0.007586262
0.00750177
0.007418219
0.007335598
0.007253898
0.007173107
0.007093217
0.007014216
0.006936095
0.006858844
0.006782454
0.006706914
0.006632216
0.006558349
0.006485306
0.006413076
0.00634165
0.00627102
0.006201176
0.00613211
0.006063814
0.005996278
0.005929494
0.005863455
0.00579815
0.005733573
0.005669716
0.005606569
0.005544126
0.005482378
0.005421318
0.005360938
0.00530123
0.005242188
0.005183803
0.005126068
0.005068977
0.005012521
0.004956694
0.004901489
0.004846898
0.004792916
0.004739535
0.004686748
0.004634549
0.004582932
0.004531889
0.004481416
0.004431504
0.004382148
0.004333342
0.004285079
0.004237354
0.00419016
0.004143492
0.004097344
0.00405171
0.004006584
0.00396196
0.003917834
0.003874199
0.00383105
0.003788382
0.003746189
0.003704465
0.003663207
0.003622408
0.003582063
0.003542168
0.003502717
0.003463705
0.003425128
0.003386981
0.003349258
0.003311956
0.003275069
0.003238593
0.003202523
0.003166855
0.003131584
0.003096706
0.003062216
0.003028111
0.002994385
0.002961035
0.002928057
0.002895445
0.002863197
0.002831308
0.002799775
0.002768592
0.002737757
0.002707265
0.002677113
0.002647297
0.002617812
0.002588656
0.002559825
0.002531315
0.002503123
0.002475244
0.002447676
0.002420415
0.002393457
0.0023668
0.00234044
0.002314373
0.002288597
0.002263108
0.002237902
0.002212978
0.002188331
0.002163958
0.002139857
0.002116024
0.002092457
0.002069152
0.002046107
0.002023318
0.002000784
0.0019785
0.001956464
0.001934674
0.001913127
0.001891819
0.001870749
0.001849914
0.00182931
0.001808936
0.001788789
0.001768867
0.001749166
0.001729684
0.00171042
0.00169137
0.001672533
0.001653905
0.001635484
0.001617269
0.001599257
0.001581445
0.001563832
0.001546414
0.001529191
0.00151216
0.001495318
0.001478664
0.001462195
0.00144591
0.001429806
0.001413882
0.001398135
0.001382563
0.001367165
0.001351938
0.001336881
0.001321991
0.001307267
0.001292708
0.00127831
0.001264073
0.001249994
0.001236072
0.001222306
0.001208692
0.00119523
0.001181918
0.001168755
0.001155738
0.001142866
0.001130137
0.00111755
0.001105103
0.001092795
0.001080624
0.001068589
0.001056687
0.001044919
0.001033281
0.001021773
0.001010393
0.000999139
0.000988011
0.000977007
0.000966126
0.000955366
0.000944725
0.000934203
0.000923799
0.00091351
0.000903336
0.000893275
0.000883326
0.000873488
0.000863759
0.000854139
0.000844626
0.000835219
0.000825917
0.000816718
0.000807622
0.000798627
0.000789732
0.000780937
0.000772239
0.000763638
0.000755133
0.000746723
0.000738406
0.000730182
0.00072205
0.000714008
0.000706056
0.000698192
0.000690416
0.000682726
0.000675123
0.000667603
0.000660168
0.000652815
0.000645545
0.000638355
0.000631245
0.000624215
0.000617262
0.000610388
0.000603589
0.000596867
0.000590219
0.000583646
0.000577145
0.000570717
0.000564361
0.000558075
0.00055186
0.000545714
0.000539636
0.000533625
0.000527682
0.000521805
0.000515994
0.000510247
0.000504564
0.000498944
0.000493387
0.000487892
0.000482458
0.000477085
0.000471771
0.000466517
0.000461321
0.000456183
0.000451102
0.000446078
0.00044111
0.000436197
0.000431339
0.000426535
0.000421784
0.000417087
0.000412441
0.000407848
0.000403305
0.000398814
0.000394372
0.00038998
0.000385636
0.000381341
0.000377094
0.000372894
0.000368741
0.000364634
0.000360573
0.000356557
0.000352586
0.000348659
0.000344776
0.000340936
0.000337139
0.000333384
0.000329671
0.000325999
0.000322368
0.000318778
0.000315227
0.000311717
0.000308245
0.000304812
0.000301417
0.00029806
0.00029474
0.000291458
0.000288211
0.000285001
0.000281827
0.000278688
0.000275584
0.000272515
0.00026948
0.000266479
0.000263511
0.000260576
0.000257674
0.000254804
0.000251966
0.00024916
0.000246385
0.000243641
0.000240927
0.000238244
0.00023559
0.000232966
0.000230372
0.000227806
0.000225269
0.00022276
0.000220279
0.000217825
0.000215399
0.000213
0.000210628
0.000208282
0.000205963
0.000203669];

function [DDOP]=ddop_func

DDOP=[2.91544E-07
6.23992E-07
9.65784E-07
2.34134E-06
3.16202E-06
5.19155E-06
6.0777E-06
9.49784E-06
1.30049E-05
1.40488E-05
1.70331E-05
2.78893E-05
2.94212E-05
3.54477E-05
4.07356E-05
4.47971E-05
4.13282E-05
6.14334E-05
5.92384E-05
6.76913E-05
7.54155E-05
8.12181E-05
7.93878E-05
7.60275E-05
9.67764E-05
9.99962E-05
0.000130931
0.000136264
0.000126274
0.000146581
0.000162073
0.000141195
0.000149472
0.000147478
0.000147387
0.000159255
0.000138707
0.000133329
0.000149856
0.000161664
0.000174954
0.000160772
0.000170914
0.000180226
0.000142771
0.000164272
0.00016453
0.000173536
0.000166144
0.000162915
0.000189782
0.000188758
0.000179787
0.000184484
0.000210578
0.000210452
0.000194969
0.000160859
0.000145988
0.000168517
0.000215088
0.00017843
0.000188643
0.000210139
0.000215024
0.000214561
0.000264226
0.000253713
0.000236094
0.00024826
0.000262738
0.000245808
0.000228292
0.000216452
0.000198168
0.000206804
0.000241882
0.00025823
0.000308151
0.000257477
0.00024876
0.000273669
0.000203129
0.000164873
0.000189844
0.000248478
0.000225981
0.000239727
0.000234641
0.000255378
0.000293338
0.000313095
0.000284889
0.000158452
0.000195566
0.000309854
0.000268168
0.000168835
0.000335577
0.000392156
0.000408101
0.000421823
0.000439602
0.000421634
0.000434033
0.000428226
0.000411684
0.000410203
0.000432349
0.000458552
0.000389972
0.000454317
0.000472585
0.00045382
0.000467906
0.000458566
0.000480904
0.000459975
0.000453385
0.000462903
0.000431279
0.000484044
0.00048317
0.000444799
0.000439444
0.000443624
0.000469486
0.000438779
0.000437919
0.000406443
0.000340154
0.000308644
0.000484104
0.000490392
0.000474176
0.000499934
0.000555784
0.000552825
0.000492566
0.000460643
0.000493527
0.000518721
0.000555738
0.000546924
0.000549118
0.000542529
0.000520186
0.00057819
0.000604183
0.000586725
0.000613125
0.000650563
0.000612021
0.000555875
0.000585735
0.000613613
0.000622337
0.000643677
0.000615259
0.000623323
0.000624979
0.000628281
0.00062232
0.000623257
0.000625492
0.000614873
0.000627362
0.000615966
0.000637486
0.000639932
0.000626943
0.000624543
0.000649554
0.00063691
0.000633976
0.000660481
0.000661099
0.00066062
0.000681579
0.000652425
0.000667191
0.000660862
0.000678267
0.000670509
0.000650943
0.000638109
0.000569564
0.000569584
0.000627814
0.000616948
0.000680819
0.000650221
0.000611192
0.000655829
0.000652936
0.000705106
0.000679966
0.000675853
0.000640694
0.000653878
0.000654469
0.000641808
0.000626908
0.00066268
0.000659766
0.000671276
0.000703452
0.000674533
0.000644015
0.000687111
0.000685165
0.000683056
0.000696468
0.000662615
0.000653047
0.000648113
0.000684197
0.000580063
0.000606932
0.000601161
0.00065991
0.000677233
0.00069309
0.000661695
0.000701677
0.000703944
0.000661943
0.000621649
0.000691861
0.000702827
0.000703106
0.000733438
0.0007006
0.000625911
0.000652944
0.000688807
0.000723482
0.000698212
0.000719325
0.000706849
0.000662659
0.000656738
0.000698284
0.000707029
0.000715799
0.000719755
0.000694001
0.000708339
0.000691841
0.000702077
0.00070665
0.000706975
0.000723525
0.000699162
0.000716334
0.000722733
0.000711744
0.000700174
0.000705424
0.000691014
0.000698709
0.000714689
0.000686087
0.000719999
0.000711988
0.000715371
0.000675332
0.000700335
0.000718099
0.00070861
0.000709731
0.000695095
0.000717903
0.000734604
0.000728805
0.000718954
0.000726883
0.00073137
0.000720293
0.000707179
0.000724145
0.000728548
0.000744538
0.000744216
0.000740853
0.000735499
0.000715549
0.00073069
0.000732232
0.000690354
0.000701651
0.000730922
0.000723128
0.000720894
0.00073239
0.000729088
0.000730209
0.000738945
0.000728916
0.000722627
0.000730701
0.000736405
0.000740353
0.000738385
0.000735566
0.0007323
0.000730332
0.000728752
0.000728296
0.000729122
0.000725885
0.00072161
0.000718252
0.000712312
0.000713626
0.000719034
0.000728986
0.00073434
0.000733832
0.0007304
0.000726666
0.000719115
0.000713158
0.000710671
0.000706754
0.000699726
0.000697343
0.00070214
0.000705746
0.000710842
0.000718435
0.000723421
0.000726854
0.000729584
0.000735006
0.00074096
0.000741352
0.000738317
0.000735317
0.000734172
0.000738402
0.000738163
0.000734528
0.000724694
0.000712677
0.000705114
0.000701679
0.000707052
0.000713148
0.000720416
0.000721175
0.000718719
0.000693863
0.000660549
0.000660418
0.00069099
0.000722447
0.000737965
0.000746075
0.000751624
0.000751563
0.000749513
0.000751044
0.000753415
0.000753066
0.000754888
0.000755951
0.000757756
0.000754089
0.000752679
0.000754044
0.000755334
0.000757922
0.000757613
0.000758904
0.000758932
0.000757665
0.000757777
0.000757419
0.000757244
0.000755463
0.000749462
0.000741283
0.000709915
0.000648864
0.000599481
0.000592372
0.000619128
0.000642626
0.000661453
0.000667069
0.000661778
0.000660071
0.000673846
0.000692942
0.000700601
0.000691967
0.000677019
0.000668368
0.000667562
0.000673992
0.000686961
0.000695443
0.000697084
0.000701297
0.000704615
0.000706822
0.000708202
0.000707354
0.000706503
0.000703269
0.000696696
0.000681734
0.000647696
0.000585949
0.00052009
0.000479345
0.000477039
0.00051563
0.00055967
0.000570064
0.000550203
0.000528353
0.000527045
0.000533198
0.000538775
0.000541921
0.000548259
0.000559107
0.000584513
0.000616537
0.000648727
0.000663208
0.000664174
0.000663723
0.000668216
0.000671909
0.000676788
0.000679269
0.00068533
0.000693799
0.000700923
0.000705753
0.00070785
0.000708165
0.00071069
0.000708399
0.000706818
0.000703523
0.00070294
0.000705417
0.000706549
0.000705813
0.000704014
0.000701281
0.000678362
0.000577987
0.000403751
0.000263277
0.000226068
0.000260167
0.000299289
0.000351942
0.000437675
0.000527577
0.000599533
0.000645159
0.000668937
0.000682103
0.000688388
0.000691514
0.000691645
0.000691118
0.000690825
0.000691594
0.000691128
0.000692642
0.000693781
0.000693134
0.000693779
0.000694546
0.00069318
0.000688942
0.000685046
0.000681816
0.000673598
0.000661859
0.00065354
0.000649479
0.000646772
0.000646965
0.000651016
0.000654909
0.000664436
0.00069565
0.000766641
0.000868926
0.000958465
0.000967922
0.000909618
0.000815892];


